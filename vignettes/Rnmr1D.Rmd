---
title: "Features illustration of the Rnmr1D package"
author: "Daniel Jacob"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Features illustration of the Rnmr1D package"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<style>
body { max-width:900px; }
</style>

## Features illustration of the Rnmr1D package

#### Rnmr1D is the main module in the NMRProcFlow web application (nmrprocflow.org) concerning the NMR spectra processing.

### Description
* Rnmr1D R package is aimed to performs the complete processing of a set of 1D NMR spectra from the FID (raw data) and based on a processing sequence (macro-command file). An additional file specifies all the spectra to be considered by associating their sample code as well as the levels of experimental factors to which they belong.

* NMRProcFlow allows experts to build their own spectra processing workflow, in order to become re-applicable to similar NMR spectra sets, i.e. stated as use-cases. By extension, the implementation of NMR spectra processing workflows executed in batch mode can be considered as relevant provided that we want to process in this way very well-mastered and very reproducible use cases, i.e. by applying the same Standard Operating Procedures (SOP). A subset of NMR spectra is firstly processed in interactive mode in order to build a well-suited workflow. This mode can be considered as the 'expert mode'. Then, other subsets that are regarded as either similar or being included in the same case study, can be processed in batch mode, operating directly within a R session.

* See the NMRProcFlow online documentation https://nmrprocflow.org/ for further information.

<br>

### Test with the extra data provided within the package

To illustrate the possibilities of Rnmr1D 1.0, we will use the dataset provided within the package. This is a very small set of 1H NMR spectra (6 samples) acquired on a Bruker Advanced III 500Mz instrument (ZG sequence, solvent D20, pH 6), derived from sunflower leaves. The experimental design of the study focused on a treatment (stress vs. control) with 3 replicates for each samples.

```{r init-object0, echo=TRUE, include=TRUE}
library(Rnmr1D)
data_dir <- system.file("extra", package = "Rnmr1D")
RAWDIR <- file.path(data_dir, "CD_BBI_16P02")
CMDFILE <- file.path(data_dir, "NP_macro_cmd.txt")
SAMPLEFILE <- file.path(data_dir, "Samples.txt")
```

The samples matrix with the correspondence of the raw spectra, as well as the levels of the experimental factors
```{r init-object1, echo=TRUE, include=TRUE}
samples <- read.table(SAMPLEFILE, sep="\t", header=T,stringsAsFactors=FALSE)
samples
```

The Macro-commands list for processing 
```{r init-object2, echo=TRUE, include=TRUE}
CMDTEXT <- readLines(CMDFILE)
options(width=128)
CMDTEXT[grep("^#$", CMDTEXT, invert=TRUE)]
```

<br>

### Do the processing

**doProcessing** is the main function of this package. Indeed, this function performs the complete processing of a set of 1D NMR spectra from the FID (raw data) and based on a processing sequence (macro-command file). An additional file specifies all the spectra to be considered by associating their sample code as well as the levels of experimental factors to which they belong. In this way it is possible to select only a subset of spectra instead of the whole set. 

```{r eval0, echo=TRUE, eval=TRUE}
out <- Rnmr1D::doProcessing(RAWDIR, cmdfile=CMDFILE, samplefile=SAMPLEFILE, ncpu=2)
```

<br>

The ouput list includes severals metadata, data and other information.
```{r proc2, echo=TRUE, eval=TRUE}
ls(out)

out$infos
```

<br>

### Stacked Plot with a perspective effect
```{r plot1, echo=TRUE, fig.align='center', fig.width=12 }
plotSpecMat(out$specMat, ppm_lim=c(0.5,5), K=0.33)
```

### Overlaid Plot
```{r plot2, echo=TRUE, fig.align='center', fig.width=12}
plotSpecMat(out$specMat, ppm_lim=c(0.5,5), K=0, pY=0.1)
```

### Some other plots to illustrate the possibilities
```{r plot3, echo=TRUE, fig.align='center', fig.width=12}
plotSpecMat(out$specMat, ppm_lim=c(0.5,5), K=0.33, asym=0)
cols<- c( rep("blue",length(out$samples$Treatment)));
cols[out$samples$Treatment=="stress"] <- "red"
plotSpecMat(out$specMat, ppm_lim=c(0.5,5), K=0.67, dppm_max=0, cols=cols)
```

<br>

### Apply additional processing 

It is possible to apply additionnal processing after the main processing. For that the doProcCmd  function can process macro-commands included in a string array to be applied on the spectra set previously generated. In the previous processing, the bucketing has been done with a uniform approach. We are going to change this by an intelligent bucketing [1], more efficient to generate relevant variables as we will further see .

```{r proc3, echo=TRUE, eval=TRUE}
specMat.new <- Rnmr1D::doProcCmd(out, 
     c( "bucket aibin 10.2 10.5 0.3 3 0", "9.5 4.9", "4.8 0.5", "EOL" ), ncpu=2, debug=TRUE)
out$specMat <- specMat.new
```

<br>

### Get the data matrix 

Before exporting, in order to make all spectra comparable each other, we have to account for variations of the overall concentrations of samples. In NMR metabolomics, the total intensity normalization (called the Constant Sum Normalization) is often used so that all spectra correspond to the same overall concentration. It simply consists to normalize the total intensity of each individual spectrum to a same value. 

```{r proc4, echo=TRUE, eval=TRUE}
outMat <- Rnmr1D::getBucketsDataset(out, norm_meth='CSN')
outMat[, 1:10]
```

<br>

### Bucket Clustering based on a lower threshold  applied on correlations

At the bucketing step (see above),  we have chosen the intelligent bucketing [[1](#ref1)], it means that each bucket exact matches with one resonance peak. Thanks to this, the buckets now have a strong chemical meaning, since the resonance peaks are the fingerprints of chemical compounds. However, to assign a chemical compound, several resonance peaks are generally required in 1D 1 H-NMR metabolic profiling. **To generate relevant clusters** (i.e. clusters possibly matching to chemical compounds), **an appropriate correlation threshold is applied on the correlation matrix before its cluster decomposition** [[2](#ref2)].

Moreover, an improvement can be done by **searching for a trade-off on a tolerance interval of the correlation threshold** : from a fixed threshold of the correlation  (cval), the clustering is calculated for the three values (cval-dC, cval,  cval+dC),  where dC is the tolerance interval of the correlation threshold.
From these three sets of clusters, we establish a merger according to the following rules: 1) if a large cluster is broken, we keep the two resulting clusters. 2) If a small cluster disappears, the initial cluster is conserved. Generally, an interval of the correlation threshold included between 0.005 and 0.01 gives a good trade-off.

#### cval=0 => threshold automatically estimated

```{r proc5, echo=TRUE, eval=TRUE}
options(warn=-1)
outclust <- Rnmr1D::getClusters(outMat, method='corr', cval=0, dC=0.005, ncpu=2)
```


```{r proc6, echo=TRUE, eval=TRUE}
outclust$clustertab[1:20, ]
outclust$clusters$C5      # same as outclust$clusters[['C5']]
```

Based on these clusters, it is possible to find candidate by querying online databases - See for example :
* HMDB - http://www.hmdb.ca/spectra/nmr/one_d/search/new,
* PeakForest - https://metabohub.peakforest.org/webapp/home?page=peakmatching, 
* SpinAssign - http://dmar.riken.jp/spinassign/
* NMRShiftDB - http://nmrshiftdb.nmr.uni-koeln.de/nmrshiftdb/media-type/html/user/anon/page/default.psml/js_pane/P-Search

<br>

### Plot the criterion curves
```{r plot5, echo=TRUE, fig.align='center', fig.width=12, fig.height=8}
plotCriterion(outclust)
```

### Boxplots of clusters

This plot allows us to have an insight on the clusters distribution - We see that they cover three orders (log scaled)

```{r plot6, echo=TRUE, fig.align='center', fig.width=12, fig.height=8}
plotClusters(outMat,outclust)
```

<br>

### PCA

PCA is a multivariate analysis without prior knowledge on the experiment design. In this way, it allows us to see the dataset as it is, projected in the two main components where data variance is maximal.

```{r proc7, echo=TRUE, eval=TRUE}
pca <- prcomp(outMat,retx=TRUE,scale=T, rank=2)
```

<br>

### Plot PCA Scores

Ellipses corresponding to the factors levels are simply added on graph. It is possible to specify their confidence level (95% by default).

```{r plot7, echo=TRUE, fig.align='center', fig.width=12, fig.height=8}
plotScores(pca$x, out$samples, 'Treatment', level=0.95)  # Choose 'Treatment' as factor, confidence level = 95%
```

### Plot PCA Loadings

Having calculated the clustering in the previous step (see above), it can be superimposed on the loadings plot in order to view its distribution and thus its efficiency. We can see that where the clusters are located, this corresponds to the maximum variance of the buckets, i.e. mainly at the ends of the first principal component (PC1).

```{r plot8, echo=TRUE, fig.align='center', fig.width=12, fig.height=10}
plotLoadings(pca$rotation, 1, 2, associations=outclust$clustertab, 
             cexlabel=0.6, level=0.6, main=sprintf("Loadings - Crit=%s",outclust$vcrit) )
```

Plot loadings with the merged variables for each cluster (based on their average)

```{r plot9, echo=TRUE, fig.align='center', fig.width=12, fig.height=10}
outMat.merged <- Rnmr1D::getMergedDataset(outMat, outclust)
pca.merged <- prcomp(outMat.merged,retx=TRUE,scale=T, rank=2)
plotLoadings(pca.merged$rotation, 1,2,  associations=outclust$clustertab, 
             cexlabel=0.6, main=sprintf("Loadings - Crit=%s",outclust$vcrit) )
```

Quod erat demonstrandum !

<br>

### References

<a name="ref1"></a>[1] De Meyer, T., Sinnaeve, D., Van Gasse, B., Tsiporkova, E., Rietzschel, E. R., De Buyzere, M. L., et al. (2008). NMR-based characterization of metabolic alterations in hypertension using an adaptive, intelligent binning algorithm. Analytical Chemistry, 80(10), 3783–3790.doi: 10.1021/ac7025964

<a name="ref2"></a>[2] Jacob D., Deborde C. and Moing A. (2013). An efficient spectra processing method for metabolite identification from 1H-NMR metabolomics data. Analytical and Bioanalytical Chemistry 405(15) 5049–5061 doi: 10.1007/s00216-013-6852-y

